# ■ 「UE4におけるエフェクトの基本戦略事例」の要約

# ■ スライドへのリンク
* [{SlideShare} UE4におけるエフェクトの基本戦略事例 前編](https://www.slideshare.net/EpicGamesJapan/ue4-138352666)
* [{SlideShare} UE4におけるエフェクトの基本戦略事例 後編](https://www.slideshare.net/EpicGamesJapan/ue4-138352671)

# ■ 要約
* 概要
	* 戦術ではなく戦略、プロジェクト全期にわたって必要になってくる作業やツールなどの情報がまとまっています。
	* プロジェクト立ち上げ段階の予算組みの段階で準備が必要になる内容となっています。
	* 特にボリュームが多い項目
		* 行ったエンジン拡張の内容
		* エフェクト描画担当エンジニアの対応内容
		* 人員増加による作業の平行化に当たっての準備(ドキュメントや座学等)
		* デザイナのアセット作成に関するレギュレーション内容
		* 検証内容、ディスク、メモリ、負荷対策に関する数字を含めた情報
	* さらに詳細な情報は別の資料にまとめられているので必要に応じてそちらも参照すること。
		* [{SlideShare} 大規模タイトルにおけるエフェクトマテリアル運用](https://www.slideshare.net/EpicGamesJapan/sqex-ue4dd)
* 読むべき人
	* 主たるターゲット
		* デザイナのリード、サブリード、ＴＡ
		* エンジニアのリード、エフェクト描画担当、エンジン拡張担当、自動化・ビルド担当
	* 補助的なターゲット
		* プロジェクトマネージャ、ディレクター(機材関連、教育回り、品質チェック関連)

# ■ スライドの内容
* エフェクトアーティストの林武尊氏の講演
	* プロジェクト内の立ち位置的には VFX リードの補佐を行うサブリード的な業務を担当。

# ■ スライド内容のメモ
* ※ここから先はほぼスライドの内容全部を書き写しただけのスライド全体の俯瞰用のテキストです。
* プロジェクトの戦略について言及	
	* エフェクトに詳しいエンジニアの確保
	* エンジンの拡張についての検討(エンジニアの負荷(エンジンバージョンアップの保守コスト)が高かった)
	* 作業の並列化の想定
	* 特殊な演出のためのアーティスト確保
		* 機材やソフトの導入のアドバイザにもなる
	* 演出に関する国内の特徴について言及
		* モーショングラフィクスよりである
		* 演出に起承転結を織り込む
* エフェクトエディタに必要な機能について言及
	* リング発生(エミッタを円状・等間隔に置く。頂点数と半径あたりがパラメータ)
	* エミッタの親子関係(親から子へのパラメータ指定、多重継承)
	* エミッタの変形対応(カーブによる)
	* エミッタ自体のビルボード(詳細不明)
	* 区間ループ(ＡＢＣＤのＢＣ間ループ。通知を受け取ることでループの突破)
	* タイムライン編集ウィンドウ( AfterEffect 的なもの)
	* カーブエディタの表示内容を選択中のものが表示されるように変更
	* カーブエディタＵＸの改善
	* 軌跡(トレイル？)の設定項目の改善(分割数やパラメータの指定方法等々)
	* ビルボードを重ねた軌跡
	* ビルボードの種類の追加
	* コンポーネントのトランスフォーム継承設定
	* GPU カールノイズの対応
	* 深度補正機能
	* ニアフェード(距離による透明度変更)、付随してスケール変更
	* 距離によるパーティクル生成数の簡易な抑制機能(標準機能が複雑すぎたため)
	* パーティクルシステム外のパラメータをパーティクルシステム側からカーブで制御(キャラクタのマテリアルやシェイクのパラメータ)
		* DynamicParameter が４つしか対応していなかったための拡張。
	* メッシュの頂点からのパーティクル発生
		* 頂点情報はメッシュから独自のデータアセットを事前生成してこれを指定する。
		* 独自データなので何でもありだが、特に法線や頂点カラーを利用できるようになっている
	* スタティックメッシュの連番再生
	* パーティクルシステムの生成(ソート問題、複雑なエフェクトの分離、流用、色を指定してのバリエーション化など)
	* パーティクルシステムからデカール用マテリアルの生成
	* アタッチ設定の拡張( Notify 設定、区間再生、再生回数、通知発生時の挙動の制御、ボーンからの警鐘、これらのデータアセット化)
	* ＵＸの改善
		* エミッタのプリセット
		* エミッタのレイヤー表示
		* 検索機能
		* 一括編集機能
		* VFX ビューア
* 拡張対応がオミットされたもの(スケジュールの関係上)	
	* Cascade からのマテリアル主要パラメータ編集(ブレンドモード切替やテクスチャ差し替えなど)
		* ※「パーティクルシステム外のパラメータをパーティクルシステム側からカーブで制御」が近いが、カーブのみなら確かに達成できない
* 特殊表現
	* マテリアル(ＴＡではなくエフェクト担当描画エンジニアが担当？)
		* 赤熱表現
		* フレネル発光
		* ディザフェード(ドット抜きする手法。カメラが酔った時などに利用される)
		* SceneTexture ノードを使用したブラー
			* 半透明対応のため限定的なシーンのみ、半透明パスで描画された内容をテクスチャに移し、 SceneColor と合成して利用といったことをした
		* パララックスオクルージョンマップ・リレーフマップ
			* コンポーネントの回転に追従するように
		* Vertex Animation Texture ・ インポスター
			* Houdini の「 Game Development Toolset 」を利用
		* デカール
			* フェードの開始距離、緩急の設定追加
			* 環境校の影響を受けない Blend Mode の追加
			* 描画対象、描画順のカスタマイズ
			* 投影先の角度によるフェードを行うマテリアルの用意
	* ポストプロセス
		* 輪郭線
			* ゲームルール内でのカテゴリごとに適用できるように
			* 不透明に隠れるように、半透明で薄くなるように
		* シーンに色を加える、ライトの色を制御する
		* ブラー
			* 影響しない領域指定機能
			* 同時指定時の際の優先度設定機能
		* メイン光源用レンズフレア
	* その他
		* レイチェックの結果でエミッタの表示切替(地形によるエミッタの切り替え等)
		* カメラ揺らしを Cascade に設定し制御できるように
		* エリアカラー
			* **導入理由については複雑なのでスライド参照**
			* 機能的には…パーシスタントレベルに代表色を手動設定
				* 以下の設定のデータテーブルを作り、ワールドセッティングにて設定
					* BasicColor への蒸散用の地面の色
					* EmissiveColor に加算する直接光の色
					* EmissiveColor に加算する環境交の色
					* 地面の影響度
			* 対応は管理者一人を立ててその人が設定
			* 時間帯の違いによるミスマッチは許容
			* トリガーボックスによる設定(管理しきれないので極力使用しない)
			* 独自のマテリアルノードから設定内容を取得できるようにし、マテリアルでも利用
* 環境
	* ドキュメント
		* Markdown/Excel/Word/OneNote 等を利用
			* OneNote には可能性を感じたようだ。
	* コミュニケーション
		* Skype/Outlook/Mattermost 等を利用
		* 質問しやすい環境づくりを目指した
	* UE4 と Perforce
		* タスクスケジューラによる最新バージョンの取得とエディタ起動で快適に
		* クックやデプロイの起動パラメータで Mattermost への投稿ができるようにしてもらった
		* フォルダカラーの利用(UE4)
	* 機材
		* 4K 大型液晶モニタ
			* 見た目の不具合確認用、打合せでの画像の共有用
		* デュアル、トリプルモニタ
		* Maya/3dsMax + V-Ray(FumeFX/PhoenixFD/Krakatoa/RayFire)/Houndini + Redshift/ZBrush/SubstanceDesginer/After Effect
		* シミュレーション＆レンダリングマシン
			* ２４コアなどの高スペックマシンを何台も。
	* ラーニング
		* アサインされた人に等しく実施
		* プロジェクトの概要説明(社内の担当部門、プロジェクト名、スケジュール的なこと、セクション代表者、ネットワーク関連の情報)
		* 座学
			* 政策課題と並行、１日１時間、２週間ぐらい。
			* 対面で行う。質疑形式で行う。そうすることで内容のブラッシュアップもしていける。
			* 業界に関する情報やハードウェア、ソフトウェア、プログラムのループについてやレンダリングの流れ、３Ｄ描画に関する知識等
			* UE4/Perforce に関する情報
		* 制作課題
			* ものがある状態から・テクスチャを作るところ・マテリアルを作るところの３段階
			* 詳細はデザイナよりのお話なので省略

## ■ 後編
* レギュレーション
	* 柔軟で、シンプルで、見た目優先
	* 反省点としては。最適化しにくく、プロジェクトが進むごとに複雑に、ワンオフが多くなった
	* 改善点としては
		* 自動化や制限などでレギュレーションを守る
		* アセットのシンプル化、汎用化
		* データサイズや処理負荷の知見が必要
	* アセットの詳細について「大規模タイトルにおけるエフェクトマテリアル運用」を参照
	* 具体的なレギュレーション内容
		* テクスチャ
			* 「テクスチャストリーミング」と「Mipmap」の仕様把握
				* 「テクスチャストリーミング」については Epic Games Japan 篠山さんの解説資料を参照(公開予定)
			* 最低限の解像度、 NoMipmap はなるべく使用しない、 NeverStream はできるだけ使用しない
			* マテリアルがシンプルになるようなテクスチャ運用
				* **詳細はスライド参照**
			* インポート時の設定変更(特定のフォルダにインポートする際に設定を変えるとか圧縮設定のデフォルトを変えるなど)
			* 定期的にプロパティマトリクスでチェックしていた(自動化できるとなおよい(していない？))
			* 大きな解像度のテクスチャがあったら、実行中に MaximumTextureSize を変えて見た目を確認し、調整する
		* マテリアル
			* 受注するマスターマテリアルは一人で管理、それ以外はエフェクトチームの誰でも作成ＯＫにした
				* メリット：全員のマテリアル作成スキルの向上
				* デメリット：数が増えやすいので、上限数を決めるなどの予防策が必要
			* Blend Mode の種類を抑えるのはマテリアル数を減らすのに有効。
				* Translucency Add Masked メインがよさそう。 Opaque は Masked で統一(要検討)
			* Shadeing Model を減らすのもマテリアル数を減らすのに有効。
				* 汎用マテリアルでは UnLit DefaultLit の２つがメイン
			* 半透明のライティングは基本無し
				* **詳細はスライド参照**
			* Render After DOF はカットシーンのみ。マテリアルは増える。
			* Emissive Color は EyeAdatptation ノードで除算することで露出補正の影響を打ち消している。
				* エラーが出るものは例外とした。
			* Usage は主たる項目は公開、デカール用は非公開とした
			* いくつかの設定は変更しないように運用(ルールのみで検出等の仕組みはなし)
			* 機能拡張
				* プロパティマトリクスの検索機能
				* ＣＳＶ出力機能
				* 一括変換コマンドレット
			* 屈折について
				* **詳細はスライド参照**
		* スタティックメッシュ
			* UV はひとつ、コリジョン不要、頂点数減らす、連番メッシュはパターン少なく
			* 設定ファイルによるインポートのデフォルト設定は適切に行うこと。
			* Houdini Engine for Maya の PolyReduce によるリダクション
		* エフェクト
			* エミッタ数
				* 親子関係などを利用していたため数が増えやすかった。
				* 運用ルールで上限を定めた。
				* 上限を超える場合、通知する方法があるとよい。
			* GPU パーティクル数
				* デフォルトの計算バッファを減らせるようにシステム上限の 1/4 程度の使用に抑えた。
				* 10 を超える生成を行う際は GPU に切り替えていた。
			* EmissiveColor の値
				* ブルームの強さ共有して目安とした
				* 色と美は描画プログラマが対処(具体的に何を対処したのか要確認)
			* ポイントライト
				* 特別感を出すため、用途を限定(ゲームデザイン的な制限)
				* 二乗減衰させないルールとした(見た目や調整による制限)
					* 距離による減衰が大きく要求するアウトプットにならない為
				* 半透明オブジェクトへの影響なし、キャスト車道なし(負荷対策)
				* 範囲は可能な限り狭く(負荷対策)
				* 強度に関して運用ルール
				* 拡張で露出補正のカウンターの追加(詳細不明)
				* LOD は運用が困難なため、主に背景で使うという限定使用
				* バウンディングボックスは絵的に許容できる最低限で設定(負荷対策)
					* カメラ外に出ると SecondsBeforeInactive 秒経過すると計算しなくなる。１０秒にしていた。
			* 色飛びの調査はまずは自力で原因調査
				* RenderDoc や RazorGPU などを利用。解決しない場合はその情報をもってエンジニアへ相談。
			* アタッチ用の骨をルートに１つ追加。まれに有用だった。
		* 半透明オブジェクトのソート
			* 背景では極力不使用(方針による制限)
			* カメラが回り込まないものであれば優先度の設定が有効
		* アセット全体的なこと
			* 強制削除に関するルール設定をしたほうがよい
* 検証したこと
	* UE4 の機能や見た目の不具合(アーティファクトの発生など)に関する検証
	* **詳細はスライド参照**
* ディスク容量
	* 平均サイズや残りアセット数で概算を出した。
	* クックと容量出力を毎週行った。集計用 C# ツール。自動化しなかったがしたほうが好ましい。
	* 具体的な数や容量の情報もあり。 **詳細はスライド参照**
* 未使用アセットの削除の流れについての説明
	* アセット名のプレフィックスに担当者情報を入れた
		* 詳しくは「大規模タイトルにおけるエフェクトマテリアル運用」参照
* メモリ
	* 具体的な数や容量の情報もあり。 **詳細はスライド参照**
	* アセット毎の上限チェックと担当者への通知の自動化をすることが望ましい。
	* Usage の組み合わせに関する情報もあり。 **詳細はスライド参照**
* 処理負荷
	* 処理負荷計測に関する基本的な考え方や具体的な手法の情報あり。 **詳細はスライド参照**
	* マテリアルに関して負荷対策のために機能を小分けにするか、マテリアル数を抑えるために機能を増やすかのバランスが重要。

----
以上。
