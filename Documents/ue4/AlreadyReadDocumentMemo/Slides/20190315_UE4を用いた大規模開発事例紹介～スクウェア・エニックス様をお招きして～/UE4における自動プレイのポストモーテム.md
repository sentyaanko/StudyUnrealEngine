# ■ 「UE4における自動プレイのポストモーテム」の要約

# ■ スライドへのリンク
* [{SlideShare} UE4における自動プレイのポストモーテム](https://www.slideshare.net/EpicGamesJapan/ue4-137253042)

# ■ 要約
* 概要
	* ポストモーテム（postmortem）：検死、事後検討
		* プロジェクトマネジメントでは振り返りや、発生した問題について、行ったアクション・原因・再発防止策などをまとめたもののこと。
	* UE4 での自動化と自動プレイの事例でまとめてあります。
	* 自動プレイのほうに比重をかけています。
	* 自動プレイの実装手法やデータ化すべきところとプログラムで実装すべきところの切り分け方法、  
	  事例を踏まえての工数的な効果や改善点などがまとめられています。
	* その他のスライドについての紹介
		* [Bayonetta2 開発ブログ：バグチェック作業の自動化について](https://www.platinumgames.co.jp/dev-bayonetta2/article/881)
		* [「ベヨネッタ2」におけるゲーム品質を上げる為の自動化 ～オートプレイと継続的なパフォーマンス計測～](https://cedil.cesa.or.jp/cedil_sessions/view/1454)
		* [無料で始める！「龍が如く」を面白くするための高速デバッグログ分析と自動化](https://cedil.cesa.or.jp/cedil_sessions/view/1621)
		* [UE4のメモリリーク対策](https://www.unrealengine.com/ja/tech-blog/dealing-with-memory-leaks-in-ue4?lang=ja)
* 読むべき人
	* 主たるターゲット
		* プログラマー（リード、自動化・ビルド担当）
	* 補助的なターゲット
		* プランナー（レベルデザイナー、テストプレイリード）
		* ディレクター（工数把握）

# ■ 講演者
* プログラマーの Sim Wei Lun David 氏の講演
	* オートメーション、エンジン、ツール、ゲームを担当

# ■ スライド内容のメモ
* ※ここから先はほぼスライドの内容全部を書き写しただけのスライド全体の俯瞰用のテキストです。
* ※方針とシステム概要でまとめなおしているため、スライドとテキストの順番が前後しています。
* 自動化の事例
	* 主要な分類ごとの対応項目
		1. データ更新の自動化
			* データ系（ HLOD　、常駐関連、テクスチャロード関連）はオートメーションテストを利用
			* 参照データ（ BMP なり VFX なり）からのアセットの更新から VCS への反映までの自動化
		1. 品質チェックの自動化
			* 処理負荷計測、目盛計測、カットシーンの連続再生など。**それぞれの数量などはスライド参照**
				1. CI システム：計測システムをオプション指定して起動
				1. 計測システム：設定をテキストデータからロードし計測実行、結果をデータベースや csv に出力
				1. CI システム：csv をファイルサーバーにアップロード
		1. システム管理の自動化
			* 起動ツール（途中失敗の処理、再開、ゲームの起動と終了、ログ観察）
			* その他（クックログ解析、成果物の整理、PGO（最適化）データのマージ）
	* **まとめについてはスライド参照**
* 自動プレイについて
	* 紹介
		* 手法についての説明、その他のスライドの紹介（入力再生、ランダムパス、固定パス）
		* 事例として「ベースを固定パスに、補助として入力再生とゲーム内データを使う方法」を以降で解説
			* テキストデータによる固定目標地点の設定と目標地点への移動をユーザ入力コマンド再現して実行
			* **相互イメージはスライド参照**
	* 方針
		1. 通しプレイの時間節約
			* 通しプレイにかかる時間が長い、個人の関心、他プロジェクトからのインスピレーション
		1. データが誰でも作れる、すぐ実行できる
			* 「規模に対して一人だけでは厳しい」「用途は通しプレイに限らない」「データ担当者３～４人との連携」「 PGO 一人は別途」
		1. 決定的な部分をできるだけデータで制御
			* ここでいう決定的とは入力による結果が一定（決定的）か否（非決定的）かということ。
				* 行動のランダム性により最終結果が異なるもののこと
			* 非決定的なものはデータでの制御が困難なため、プログラムで対応を行う。
		1. シンプルなデザイン
			* 工数的な問題、データ作成が困難なものを優先してデバッグコマンド化
		1. デバッグ機能があるビルドで
			* 
	* システム概要
		* 全般
			* 「自動プレイレコーダー、自動プレイ、自動プレイリスト」を用いて時間の節約
			* 「起動引数」「テキストデータ参照」「通知のフック」「デバッグコマンドでの制御」「 GameInstance チェックの最後辺り」はほかでも流用
		* レコーダー
			* テキストにすることで誰でも作れ実行できるようにした
			* ゲーム中にデバッグ入力を開始することでボタンの入力内容をテキストデータとして出力
			* 出力した内容を調整する場合はテキストを手で調整し、自動プレイ用テキストデータの完成。
		* 自動プレイ（移動）
			* 座標を中心とした制御
		* 自動プレイ（ステート）
			* 最終的に３１個のステートを持っていた（無効、初期化、移動中、ＣＳ、終了処理、ＵＩ画面、ギミック、ゲームモード、等々）
			* 入力内容が異なる部分に関してはステートの割り込みが発生するためステート遷移が複雑になる。
				* **詳細はスライド参照**
			* 入力データで対応的ないところは Manager/Pawn 等から情報を取得して自動処理を行う。
				* **詳細はスライド参照**
		* 自動プレイ（ギミック）
			* 「プレイヤー技でクリア」「プレイヤー以外の何かを操作」「ミニゲーム」など。
			* それぞれ Manager/Pawn 等から情報を取得して自動処理を行う。
		* 自動プレイ（バグ検知とタグ）
			* 「コリジョン抜け」「ハマり」などを時間経過や KillZ から検知し、ログ、スクショ、ダンプを保存する
		* 自動プレイ（バトル/PGO 向けバトル）
			* バトル：「一直線に移動」「一定距離内に攻撃連打」「敵全滅デバッグコマンド」「プレイヤー無敵デバッグコマンド」
			* PGO 向けバトル：「ロックオン」「プレイヤーの技」「重いバトルと技の最適化」
		* 自動プレイ（その他の機能）
			* 移動のループ
			* ゲームオーバーのリプレイ選択時のチェックポイント動作テスト（未使用）
		* 自動プレイ（起動）
			* コマンドライン引数でテキストの指定をしたりループなどの設定を指定したりさせていた。
		* リスト
			* 方針１～４をもとにデータを作成
			* 「データの連続再生」「ワールド単位でデータ作成」「リストファイルでワールド単位のデータを指定」
			* テキスト読み込みと解析は UE4 の機能を利用
				* FFileHelper::LoadFileToString() FString::ParseIntoArray() など
	* 実装コスト
		* プログラマー
			* ゼロからの実装２か月、フィーチャーコンプ１か月、サポートコスト９か月
			* サポートコスト：データ更新、要望対応、システムバグ対応などがプロジェクト最後まで発生、
		* 通しプレイデータ
			* 実際の更新頻度と調整を行った機関の情報あり。**詳細はスライド参照**
	* 運営
		* フロー
			1. 担当者３～４人でデータ作成と調整
			1. 毎日実行、成果物を手でアップロード（開発機８～１４台使用）
			1. データ担当者が成果物のチェック
			1. 成果物や問題をメッセージかメールで共有
			1. データの問題の場合データを更新、システムの問題の場合はシステム担当者が更新
			* **詳細はスライド参照**
		* VCS ルール
			* 通しプレイと PGO 用データだけ対象とした
			* ボス周回、ハング再現などはローカル（一時利用で使える期間が限られるため？）
* 自動プレイの実績
	* 活用できたところ
		1. クオリティチェック
			* 通しプレイ、背景チェック、ボス周回で動作確認、サウンド班目線のチェック
		1. 長時間に渡る確認
			* エージング、低確率ハング再現、修正確認、メモリリーク
		1. 最適化
			* PGO データ再生、目盛とロード時間監視、テクスチャプール監視
	* まとめ
		* 広く活用された（ＱＡ、背景、ＴＡ、最適化、サウンド、バトル、プログラマー、プランナー）
		* 再現困難なバグの修正に有用だった
		* 900 人日程度の自動プレイを行えた
	* ネックだった点と改善方法
		* メンテコストが高かった
			* バランスを考えて市住む設計する
		* データ編集の難度が高い
			* 編集ツールとフォーマットの見直し
		* フラグが多くコマンド指定が困難
			* ＧＵＩ化
		* バグの原因解析が困難
			* 録画とログの向上
		* システム自体の処理負荷があっ太が、計即しなかった
			* マルチスレッド化、外部ツール化
	* その他の改善点
		* **詳細はスライド参照**


----
以上。
